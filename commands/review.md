---
description: 对照功能规格审查代码改动，运行测试，可选浏览器验证
argument-hint: 可选的功能名称或分支名（省略时自动从当前分支检测）
---

# 代码审查

你正在进行一次综合性代码审查，验证实现是否符合功能规格，检查代码质量，并运行测试。

## 角色定义

**角色**：资深代码审查专家

**核心职责**：
1. **规格合规审查**：对照 EARS 需求验证代码
2. **质量审查**：审查代码质量、缺陷和规范合规性
3. **置信度过滤**：只报告高置信度问题（≥80%）

**置信度评分标准**：
- **0**：完全不自信。这是误报或已有的既存问题。
- **25**：略有自信。可能是真实问题，但也可能是误报。
- **50**：中等自信。是真实问题，但可能是吹毛求疵，实践中不常发生。
- **75**：高度自信。经过核实，很可能是实践中会遇到的真实问题。
- **100**：绝对确定。确认是实践中频繁发生的真实问题。

**只报告置信度 ≥ 80 的问题。质量优于数量。**

---

## 核心原则

- **规格优先验证**：在进行通用质量审查之前，先对照 EARS 需求验证代码
- **基于证据**：只报告高置信度问题（≥80%）
- **可操作性**：每个问题都必须有具体的修复建议
- **使用 TodoWrite**：全程跟踪进度

---

## 阶段一：检测上下文

**目标**：确定审查对象并找到关联的规格文档

**操作**：
1. 如果提供了参数（$ARGUMENTS），以此作为功能名称；否则从当前分支检测：
   ```bash
   git branch --show-current
   ```
2. 从分支名提取功能名称（如有则去掉 `feature/` 前缀）
3. 查找规格文档：`.claude/specs/[功能名称].md`
4. 查找任务计划：`.claude/tasks/[功能名称].md`
5. 获取要审查的差异：
   ```bash
   # 当前分支相对于合并基点的改动
   git diff $(git merge-base HEAD main)..HEAD
   ```
   （依次尝试 `main`、`master`、`develop` 作为基线分支）
6. 为所有阶段创建 todo 列表
7. 向用户报告：
   - 当前分支
   - 是否找到规格文档 (spec.md)
   - 是否找到任务计划 (task.md)
   - 变更文件数量 / 变更行数

---

## 阶段二：规格合规检查

**目标**：验证每条规格需求都已实现

**条件**：仅在阶段一找到规格文档时执行

**审查范围**：
1. **功能需求验证**：检查每条 FR 需求及其验收标准是否得到满足
2. **任务执行检查**：对照实施计划（task.md）检查任务列表中的逻辑是否按计划实现
3. **缺失标记**：报告所有缺失、不完整或实现偏离计划的地方

**输出分组**：
1. **规格合规问题**：未满足的需求或验收标准
2. **严重缺陷**（置信度 90-100）：确认会阻碍功能的问题
3. **重要问题**（置信度 80-89）：可能影响质量的问题

**操作**：
1. 读取 `.claude/specs/[功能名称].md` 和 `.claude/tasks/[功能名称].md` 的完整内容
2. 基于 git diff 进行规格合规审查
3. 汇总规格和任务合规发现

---

## 阶段三：代码质量审查

**目标**：审查代码质量、缺陷和规范合规性

**审查维度**：
1. **质量**：代码重复、复杂度、可读性和 DRY 原则
2. **缺陷**：逻辑错误、空值处理、竞态条件、安全漏洞和边界情况
3. **规范**：是否遵循项目规范（CLAUDE.md 等）、命名规范、导入模式和架构边界

**操作**：
1. 基于 git diff 进行全面代码质量审查
2. 汇总所有发现

---

## 阶段四：执行测试

**目标**：运行项目测试套件并报告结果

**操作**：
1. 从项目中检测测试运行器：
   - Node.js：查找 `package.json` 脚本（`test`、`jest`、`vitest`）
   - Python：查找 `pytest`、`unittest`
   - 其他：查找 `Makefile` 的 `test` 目标
2. 运行测试：
   ```bash
   # 例如：npm test、pytest、go test ./...
   ```
3. 报告：
   - 通过 / 失败 / 跳过的测试数
   - 与变更代码相关的测试失败情况

---

## 阶段五：浏览器验证（如适用）

**目标**：验证 UI 改动在浏览器中正常工作

**条件**：仅当项目有前端/UI 组件时执行

**操作**：
1. 检查项目是否有开发服务器（查找 `package.json` 的 `dev`/`start` 脚本、Django 开发服务器等）
2. 如果有，且浏览器 MCP 工具可用（例如 `chrome-devtools`）：
   - 启动开发服务器
   - 使用浏览器工具导航到受影响的 UI 区域
   - 检查控制台报错、视觉回归、交互异常
   - 报告发现的问题
3. 如果没有浏览器 MCP，提示用户：
   "请在浏览器中手动验证 UI 改动。需要重点检查的区域：[列出 diff 中受影响的 UI 区域]"

---

## 阶段六：汇总报告与决策

**目标**：呈现所有发现并获取用户决定

**操作**：
1. 呈现汇总报告：
   ```
   ## 审查总结：[功能名称]

   ### 规格合规
   ✅ FR-001：[通过] / ❌ FR-002：[问题描述]

   ### 严重问题（合并前必须修复）
   1. [问题] — [文件:行号] — 置信度：95%

   ### 重要问题
   1. [问题] — [文件:行号] — 置信度：82%

   ### 测试
   ✅ 所有测试通过 / ❌ N 个测试失败

   ### 浏览器验证
   ✅ 无问题 / ❌ [发现的问题]
   ```

2. 询问用户：
   - "现在修复所有问题？"
   - "只修复严重问题？"
   - "按现状继续？"（记录已知问题）

3. 根据用户决定修复相应问题

---

## 阶段七：总结

**操作**：
1. 标记所有 todo 为完成
2. 如果所有规格需求都已确认实现，更新规格文档开发元数据：
   - 状态：已审查
   - 审查日期
3. 总结：
   - 规格合规：已验证 X/Y 条需求
   - 已修复/残留问题
   - 测试状态
   - 是否可以合并？（分支名称）
