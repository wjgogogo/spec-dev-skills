---
description: 为功能生成基于 EARS 方法论的需求规格说明文档
argument-hint: 功能描述（例如："使用 OAuth 的用户认证"）
---

# 规格文档生成

你正在帮助开发者使用 EARS（简易需求语法方法）创建一份结构化的需求规格说明文档。

## 核心原则

- **规格优先**：绝不跳过规格说明直接实现——需求必须先明确、达成一致
- **EARS 语法**：所有需求使用正确的 EARS 模式（通用型、状态驱动、事件驱动、可选功能、不良行为）
- **可测试性**：每条需求都必须通过验收标准可验证
- **使用 TodoWrite**：全程跟踪进度

---

## 阶段一：理解功能

初始请求：$ARGUMENTS

**操作**：
1. 为所有阶段创建 todo 列表
2. 如果功能描述不清晰或过于模糊，向用户提问：
   - 这个功能要解决什么问题？
   - 用户/参与者是谁？
   - 期望的核心行为是什么？
   - 明确不包含哪些内容（范围外）？
3. 在继续之前向用户确认你的理解

---

## 阶段二：生成规格文档

**目标**：产出完整的 EARS 格式规格文档

**操作**：
1. 确定模板文件路径：尝试读取 `.claude/templates/spec.md`，如果不存在，则使用插件内置模板 `${CLAUDE_PLUGIN_ROOT}/templates/spec.md`。
2. 启动 `spec-writer` agent，传入：
   - 功能描述
   - 阶段一中收集到的问题答案
   - 模板路径：上面确定的实际路径
   - 指令：**严格按照模板的章节结构**生成规格文档，包含：概述、环境分析、参与者分析、功能需求（EARS 格式 + Given/When/Then 验收标准）、非功能需求、约束条件、依赖关系、范围外
3. 仔细审查生成的规格文档：
   - 是否完整覆盖了模板的所有章节？
   - 主要行为是否都覆盖了（含正常路径和异常路径）？
   - 是否处理了错误情况（不良行为模式）？
   - 是否有歧义或遗漏？
4. 进行必要的改进，确保与模板结构一致

---

## 阶段三：与用户确认

**目标**：保存前确保规格文档准确捕捉了需求

**操作**：
1. 将完整规格文档呈现给用户
2. 询问："这份规格文档是否准确捕捉了你的需求？有什么需要增加、修改或删除的吗？"
3. **等待用户反馈**
4. 根据用户要求进行修改

---

## 阶段四：保存规格文档

**目标**：保存最终确认的规格文档

**操作**：
1. 确定功能名称（kebab-case 格式，例如：`user-auth`、`payment-flow`）
2. 如果目录不存在，创建 `.claude/specs/` 目录：
   ```bash
   mkdir -p .claude/specs
   ```
3. 将规格文档保存到 `.claude/specs/[功能名称].md`
4. 向用户确认：
   - 规格文档保存路径
   - 如何开始开发：`/dev [功能名称]`

---

## 阶段五：总结

**操作**：
1. 标记所有 todo 为完成
2. 展示：
   - 规格文档保存路径：`.claude/specs/[功能名称].md`
   - 已定义的功能需求数量
   - 已定义的非功能需求数量
   - 下一步：执行 `/dev [功能名称]` 开始实现
