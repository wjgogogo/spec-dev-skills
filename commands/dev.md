---
description: 根据规格文档实现功能，支持 git worktree 隔离开发模式
argument-hint: 功能名称 [--worktree]（例如："user-auth" 或 "user-auth --worktree"）
---

# 功能开发

你正在帮助开发者实现一个已有规格文档的功能。规格优先的方式确保你构建的正是事先商定的内容。

## 核心原则

- **规格驱动**：每个实现决策都追溯到规格需求
- **分支隔离**：在写任何代码之前，始终创建专用分支（或 worktree）
- **编码前先确认**：在实现开始前解决所有歧义
- **使用 TodoWrite**：全程跟踪所有进度

---

## 阶段一：解析参数并加载规格

初始参数：$ARGUMENTS

**操作**：
1. 解析参数：
   - 功能名称：第一个参数（例如：`user-auth`）
   - Worktree 模式：检测是否存在 `--worktree` 标志
2. 加载规格文档：读取 `.claude/specs/[功能名称].md`
3. 如果规格文档不存在：
   - 通知用户："在 `.claude/specs/[功能名称].md` 未找到规格文档"
   - 询问："是否先执行 `/spec [功能名称]` 来创建规格？"
   - 停止并等待用户决定
4. 为所有阶段创建 todo 列表
5. 向用户展示规格摘要：功能名称、需求数量、关键参与者

---

## 阶段二：创建分支或 Worktree

**目标**：在编写任何代码前隔离开发工作

**普通模式**（无 `--worktree` 标志）：
```bash
git checkout -b feature/[功能名称]
```

**Worktree 模式**（有 `--worktree` 标志）：
```bash
# 在同级目录创建带新分支的 worktree
git worktree add ../[功能名称] -b feature/[功能名称]
```
之后所有工作在 `../[功能名称]/` 目录中进行。

**操作**：
1. 执行上述对应的 git 命令
2. 更新规格文档 `.claude/specs/[功能名称].md`，在顶部添加开发元数据：
   ```markdown
   ## 开发信息
   - **分支**：feature/[功能名称]
   - **Worktree 路径**：../[功能名称]  ← （仅 --worktree 模式）
   - **开始时间**：[当前日期]
   - **状态**：进行中
   ```
3. 告知用户当前使用的模式以及创建的分支/worktree

---

## 阶段三：代码库探索

**目标**：在规划实现前了解现有代码库

**操作**：
1. 启动 1 个 `code-explorer` agent，传入：
   - "查找与 [功能名称] 相似的功能或模式，完整追踪其实现；同时梳理整体架构，识别相关的关键抽象层"
2. 阅读 agent 返回的所有关键文件
3. 向用户呈现需要遵循的模式和规范摘要

---

## 阶段四：实现规划

**目标**：根据规格需求创建详细的任务计划，并保存为 task 文件

**操作**：
1. 确定模板文件路径：尝试读取 `.claude/templates/task.md`，如果不存在，则使用插件内置模板 `${CLAUDE_PLUGIN_ROOT}/templates/task.md`。
2. 启动 `dev-planner` agent，传入：
   - 规格文档内容（`.claude/specs/[功能名称].md`）
   - 阶段三的代码库探索发现
   - 模板路径：上面确定的实际路径
   - 指令：**严格按照模板的章节结构**生成实现计划，包含：实现思路、需求映射表、分阶段任务列表（每条任务标注文件和来源需求）、关键文件、潜在风险、开放问题
3. 将生成的实现计划保存到 `.claude/tasks/[功能名称].md`：
   ```bash
   mkdir -p .claude/tasks
   ```
4. 审查计划，向用户展示：
   - 任务总数和阶段划分
   - 需要新建/修改的文件列表
   - 开放问题清单（将在阶段五确认）


---

## 阶段五：澄清问题

**目标**：编码前解决所有歧义

**重要**：如果存在待解决问题，不得跳过此阶段。

**操作**：
1. 审查规格需求和实现计划，找出所有缺口或歧义
2. 列出所有未解决的问题（边界情况、集成细节、设计偏好）
3. **向用户呈现问题列表并等待答复**
4. 如果用户说"用你认为最好的方式"，在继续前确认你的决策

---

## 阶段六：实现

**目标**：按照规格文档构建功能

**未经用户批准（阶段五问答结束后）不得开始实现**

**操作**：
1. 按阶段依次完成 dev-planner 的任务列表
2. **[关键安全断言]** 如果是 worktree 模式：
   - **在采取任何操作前，你必须先 `cd ../[功能名称]` 切换到该目录**。
   - 之后的所有命令行工具、文件读写（ls, grep, cat, 编辑器等）都必须基于该工作树内执行。
   - 绝对禁止在未切换目录前就修改主工作区的文件！
3. 对于每个子任务：
   - 先阅读相关现有文件（需遵循上述路径规则）
   - 遵循阶段三发现的代码库规范进行实现
   - 将实现追溯到规格需求
   - 完成每个任务后更新 todo

---

## 阶段七：总结

**目标**：记录完成情况

**操作**：
1. 标记所有 todo 为完成
2. 更新规格文档 `.claude/specs/[功能名称].md` 的开发元数据：
   - 状态：已完成
   - 完成日期
3. 总结：
   - 构建了什么、实现了哪些规格需求
   - 创建/修改的文件
   - 包含改动的分支（或 worktree 路径）
   - 下一步：执行 `/review` 对照规格审查代码
